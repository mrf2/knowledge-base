# Intel 8051 Microcontroller

## ISR - Interrupt Service Routine
On the 8051, an ISR is a special function that runs automatically when an ***event occurs*** (*timer overflow, serial byte received, external pin change, etc.*). Instead of main loop constantly checking flags, the hardware **jumps to a fixed memory vector***.


 * Why Important?
   * Digital clocks (timers generate periodic interrupts)
   * Communication stacks (UART/serial interrupts)
   * Small OS kernels (tick interrupts, context switching)
 * **Reset Interrupt, Vector Address - `0x0000`, Priority - Highest**

### Interrupt Structure
The 8051 core provides **5 interrupt sources: 2 external interrupts, 2 timer interrupts, and the serial port interrupt**.

#### Interrupt Enables
Each of the interrupt sources can be individually **enabled** or **disabled** by ***setting*** or ***clearning*** a bit in the SFR (*Special Function Register*) name IE (*Interrupt Enable*). This register also contains a global disable bit, which can be **cleared** to **disable** all interrupts at once.

```bash
 (MSB)                                             (LSB)
+------+------+------+------+------+------+------+------+
|  EA  |  --  |  --  |  ES  |  ET1 |  EX1 |  ET0 |  EX0 |
+------+------+------+------+------+------+------+------+
     Figure: IE (Interrupt Enable) Register in the 8051

Enable bit = 1 enables the interrupt.
Enable bit = 0 disables it.
```
|Symbol|Position|Function|
|---|---|---|
|EA|IE.7|Disables all interrupts. If EA = 0, no interrupt will be acknowledged. If EA = 1, each interrupt source is individually enabled or disabled by setting or clearing its enable bit.|
|-|IE.6|reserved|
|-|IE.5|reserved|
|ES|IE.4|Serial Port Interrupt enable bit.|
|ET1|IE.3|Timer 1 Overflow Interrupt enable bit.|
|EX1|IE.2|External Interrupt 1 enable bit.|
|ET0|IE.1|Timer 0 Overflow Interrupt enable bit.|
|EX0|IE.0|External Interrupt 0 enable bit.|

#### Interrupt Priorities
Each interrupt source can also be individually programmed to one of two priority levels by ***setting*** or ***clearing*** a bit in the **SFR** named **IP (Interrupt Priority)**.
 * A low-priority interrupt can be interrupted by a high-priority interrupt, but not by another low-priority interrupt. A high-priority interrupt can't be interrupted by any other interrupt source.
 * If two interrupt requests of different priority levels are received simultaneously, the rquest of higher priority level is **serviced**. If interrupt requests of the same priority level are received simultaneously, an internal polling sequence determines which request is serviced. Thus within each priority level there is a second priority structure determined by the ***polling sequence***.

```bash
 (MSB)                                             (LSB)
+------+------+------+------+------+------+------+------+
|  --  |  --  |  --  |  PS  |  PT1 |  PX1 |  PT0 |  PX0 |
+------+------+------+------+------+------+------+------+
   Figure: IP (Interrupt Priority) Register in the 8051
Priority bit = 1 assigns high priority.
Priority bit = 0 assigns low priority.
```
|Symbol|Position|Function|
|---|---|---|
|---|IP.7|reserved|
|---|IP.6|reserved|
|---|IP.5|reserved|
|PS|IP.4|Serial Port interrupt priority bit|
|PT1|IP.3|Timer 1 interrupt priority bit|
|PX1|IP.2|External Interrupt 1 priority bit|
|PT0|IP.1|Timer 0 Interrupt priority bit|
|PX0|IP.0|External Interrupt 0 priority bit|

---
### Operation
In operation, all the interrupt flags are latched into the interrupt control system during ***State 5*** of every machine cycle. ***The samples are polled during the following machine cycles***. 
 * If the flag for an enabled interrupt is found to be set (1), the interrupt system generates an **LCALL** to the appropriate location in ***Program Memory***, unless some other condition **blocks the interrupt**. *Several conditions can block an interrupt, among them that an interrupt of equal or higher priority level is already in progress*.
 * The hardware-generated LCALL causes the contents of the Program Counter to be pushed onto the stack, and reloads the PC with the beginning address of the service routine. The service routine for each interrupt begins at a fixed location.
 * Only the Program Counter is automatically pushed onto the stack, not the PSW or any other register. 

|Vector Number|Address|Interrupt Name/Interrupt Source|Interrupt Flag|Priority Number|
|---|---|---|---|---|
|0|`0x0003`|External INT0 (P3.2)|`IE0`|1|
|1|`0x000B`|Timer0 TF0 Overflow|`TF0`|2|
|2|`0x0013`|Extenal Interrupt INT1 (P3.3)||3|
|4|`0x001B`|Timer1 TF1|`TF1`|-|4|
|5|`0x0033`|PCA (CF or CCFn)|-|5|
|6|`0x0023`|UART (RI or TI)|-|6|
|7|`0x002B`|Timer2 (TF2)|-|7|
|8|`0x0043`|ADC (ADCI)|-|8|
|9|`0x0053`|SPI Interrupt|-|9|

## Instructions
 * **Jump instructions**
   * **LJMP** (Long Jump): 3 bytes $\rightarrow$ `opcode (1B)` + `16-bit address (2B)` $\rightarrow$ total 3 bytes, full **64 KB address range**.
   * **AJMP** (Absolute Jump): 2 bytes $\rightarrow$ `opcode (1B)` + `11-bit address (embedded in opcode + address byte)` $\rightarrow$ can only jump **within the same 2KB page**.
   * **SJMP** (Short Jump): 2 bytes $\rightarrow$ `opcode (1B)` + signed 8-bit offset ($\pm$ 127 bytes)

## Timer
Timer Special Function Registers
|Timer SFR|Purpose|Address|Bit-Addressable|
|---|---|---|---|
|TCON|Control|0x88H|Yes|
|TMOD|Mode|0x89H|No|
|TL0|Timer 0 low-byte|0x8A|No|
|TL1|Timer 1 low-byte|0x8B|No|
|TH0|Timer 0 high-byte|0x8C|No|
|TH1|Timer 1 high-byte|0x8D|No|

 * TMOD - The TMOD register contains two groups of four bits that set the operating mode for **Timer 0** and **Timer 1**. **TMOD** is not bit-addressable. Generally, it is loaded once by software at the beginning of the program to iniitialize the timer mode. Thereafter, the timer can be ***stopped, started, and so on*** by accessing the other timer SRFs.


### Timer mode
 * **Mode 0** - 13-Bit Timer Mode
 * **Mode 1** - 16-Bit Timer Mode
 * **Mode 2** - 8-Bit Timer Mode
 * **Mode 3** - Split Timer Mode

## Acronym and Abbreviation
|Acronym/Abbreviation|Meaning|Uses/Notes|
|---|---|---|
|ALE|Address Latch Enable||
|$\overline{EA}$|External Access||
|PCON|Power Control Register||
|$\overline{PSEN}$|Program Store Enable||
|PSW|Program Status Word||
|RST|Reset||
|SBUF|Serial Port Buffer Register||
|SCON|Serial Port Control Register||
|SFR|Special Function Register||
|TCON|Timer Control Register||
|TMOD|Timer Mode Register||

### TMOD (timer mode) register summary
|Bit|Name|Timer|Description|
|---|---|---|---|
|7|GATE|1|Gate bit. When set, timer only runs while $\overline{INT1}$ is high Counter/timer select bit.|
|6|C / $\overline{T}$|1|Counter/timer select bit.<br>1 = event counter<br>0 = interval time|

